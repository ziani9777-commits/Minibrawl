name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ðŸŸ¢ Java 17 obligatoire pour buildozer
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    # ðŸŸ¢ Installer dÃ©pendances Linux pour Kivy / Buildozer
    - name: Install system dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update

        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses-dev \
          libtinfo-dev \
          cmake \
          libffi-dev \
          libssl-dev

    # ðŸŸ¢ Installer Buildozer + Cython
    - name: Install Python dependencies
      run: |
        pip install --user buildozer cython
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    # ðŸ’£ Installer Android SDK + FIX BUILDOZER (le hack magique)
    - name: Install Android cmdline-tools + Fix sdkmanager
      run: |
        ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        mkdir -p $ANDROID_HOME/cmdline-tools
        cd $ANDROID_HOME/cmdline-tools

        wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
        unzip tools.zip
        mv cmdline-tools latest

        # ðŸ”¥ HACK pour Buildozer (trÃ¨s important)
        mkdir -p $ANDROID_HOME/tools/bin
        ln -s $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager $ANDROID_HOME/tools/bin/sdkmanager
        ln -s $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager $ANDROID_HOME/tools/bin/avdmanager

        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH

    # ðŸŸ¢ Accepter licences Android
    - name: Accept Android licenses
      run: yes | sdkmanager --licenses

    # ðŸŸ¢ Installer plateformes Android requises
    - name: Install Android platforms
      run: |
        sdkmanager "platform-tools"
        sdkmanager "platforms;android-33"
        sdkmanager "build-tools;33.0.2"

    # ðŸŸ¢ Build APK avec Buildozer
    - name: Build with Buildozer
      run: |
        buildozer -v android debug

    # ðŸ“¦ Upload APK en artifact GitHub
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Minibrawl-APK
        path: bin/*.apk
